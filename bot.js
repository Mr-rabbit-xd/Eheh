// =========================
// Bot.js (Part 1/3)
// =========================

// Dependencies
import TelegramBot from "node-telegram-bot-api";
import mongoose from "mongoose";
import dotenv from "dotenv";

dotenv.config();

// Connect MongoDB
mongoose.connect(process.env.MONGO_URI, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
})
.then(() => console.log("‚úÖ MongoDB Connected"))
.catch((err) => console.log("‚ùå Mongo Error: " + err));

// Bot Token
const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });

// =========================
// Schema / Models
// =========================
const userSchema = new mongoose.Schema({
  userId: String,
  username: String,
  wallet: { type: Number, default: 0 },
  referralCode: String,
  referredBy: String,
  totalReferrals: { type: Number, default: 0 },
  role: { type: String, default: "user" }, // user, reseller, admin, owner
  createdAt: { type: Date, default: Date.now }
});

const settingsSchema = new mongoose.Schema({
  key: String,
  value: String
});

const User = mongoose.model("User", userSchema);
const Settings = mongoose.model("Settings", settingsSchema);

// =========================
// Helper Functions
// =========================
async function getReferralBotUsername() {
  let setting = await Settings.findOne({ key: "referralBotUsername" });
  if (!setting) {
    setting = new Settings({ key: "referralBotUsername", value: "YourBotUsername" });
    await setting.save();
  }
  return setting.value;
}

async function setReferralBotUsername(username) {
  let setting = await Settings.findOne({ key: "referralBotUsername" });
  if (!setting) {
    setting = new Settings({ key: "referralBotUsername", value: username });
  } else {
    setting.value = username;
  }
  await setting.save();
}

// =========================
// Start / Welcome Message
// =========================
bot.onText(/\/start (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const refCode = match[1];

  let user = await User.findOne({ userId: chatId });
  if (!user) {
    const newUser = new User({
      userId: chatId,
      username: msg.from.username || "NoUsername",
      referralCode: chatId.toString()
    });
    if (refCode && refCode !== chatId.toString()) {
      newUser.referredBy = refCode;
      const refUser = await User.findOne({ referralCode: refCode });
      if (refUser) {
        refUser.totalReferrals += 1;
        refUser.wallet += 5; // Referral bonus
        await refUser.save();
        await bot.sendMessage(refUser.userId, `üéâ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶è‡¶∏‡ßá‡¶õ‡ßá! Wallet ‡¶è ‚Çπ5 ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
      }
    }
    await newUser.save();
    user = newUser;
  }

  const referralBotUsername = await getReferralBotUsername();

  bot.sendMessage(chatId, 
`üëã Welcome *${msg.from.first_name}* to the Bot!  

üîë ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶ø Key ‡¶ï‡¶ø‡¶®‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶è‡¶¨‡¶Ç Refer ‡¶ï‡¶∞‡ßá ‡¶Ü‡ßü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§  

üëâ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Referral Link:
https://t.me/${referralBotUsername}?start=${user.referralCode}

üí∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Wallet: ‚Çπ${user.wallet}`, {
    parse_mode: "Markdown",
    reply_markup: {
      inline_keyboard: [
        [{ text: "üí≥ Wallet", callback_data: "wallet" }],
        [{ text: "üéÅ Referral", callback_data: "referral" }],
        [{ text: "üõí Buy Key", callback_data: "buykey" }],
        [{ text: "üéâ Offers", callback_data: "offers" }]
      ]
    }
  });
});

bot.onText(/\/start$/, async (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "üëâ ‡¶¨‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá /start ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§");
});

// =========================
// Bot.js (Part 2/3)
// =========================

// =========================
// User Menu Inline Buttons
// =========================
bot.on("callback_query", async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;
  const user = await User.findOne({ userId: chatId });
  if (!user) return bot.answerCallbackQuery(query.id, { text: "‚ùå User not found." });

  if (data === "wallet") {
    bot.sendMessage(chatId, `üí∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Wallet Balance: ‚Çπ${user.wallet}`);
  }

  if (data === "referral") {
    const referralBotUsername = await getReferralBotUsername();
    bot.sendMessage(chatId,
`üë• ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Referral Link:
https://t.me/${referralBotUsername}?start=${user.referralCode}

‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞: ${user.totalReferrals}`, { parse_mode: "Markdown" });
  }

  if (data === "buykey") {
    bot.sendMessage(chatId, `üõí Key ‡¶ï‡¶ø‡¶®‡¶§‡ßá /buykey ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
  }

  if (data === "offers") {
    bot.sendMessage(chatId, `üéâ Current Offers:
1. Deposit ‚Çπ500+ get 5% bonus
2. Referral bonus ‚Çπ5 per user
3. Special time cashback (Admin set)`);
  }
});

// =========================
// Deposit System
// =========================
const depositStep = {};
const utrStep = {};

bot.onText(/\/deposit/, async (msg) => {
  const chatId = msg.chat.id;
  depositStep[chatId] = true;
  bot.sendMessage(chatId, "üí∞ Deposit Amount ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‚Çπ):");
});

bot.on("message", async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  if (depositStep[chatId] && !isNaN(text)) {
    const amount = parseInt(text);
    utrStep[chatId] = { amount };
    depositStep[chatId] = false;
    bot.sendMessage(chatId, `üì• Deposit ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ‚Çπ${amount}\nUTR/Txn ID ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§`);
    return;
  }

  if (utrStep[chatId]) {
    const utr = text.trim();
    if (utr.length < 12) return bot.sendMessage(chatId, "‚ùå UTR 12+ character ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");

    // Save deposit request (DB or memory)
    if (!global.deposits) global.deposits = [];
    global.deposits.push({ userId: chatId, amount: utrStep[chatId].amount, utr, status: "pending" });

    bot.sendMessage(chatId, `‚úÖ Deposit request ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ‚Çπ${utrStep[chatId].amount}\nUTR: ${utr}\nAdmin approval ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);

    // Notify admin
    bot.sendMessage(process.env.ADMIN_ID, `üì¢ New Deposit:\nUser: ${user.username} (${chatId})\nAmount: ‚Çπ${utrStep[chatId].amount}\nUTR: ${utr}`);
    
    utrStep[chatId] = null;
    return;
  }
});

// =========================
// Promo/Offer System
// =========================
bot.onText(/\/promo (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const code = match[1].toUpperCase();
  const validCodes = ["WELCOME5", "BONUS10", "FREEKEY"];

  if (!validCodes.includes(code)) return bot.sendMessage(chatId, "‚ùå Invalid promo code.");

  const bonus = code === "WELCOME5" ? 5 : code === "BONUS10" ? 10 : 0;
  user.wallet += bonus;
  await user.save();

  bot.sendMessage(chatId, `üéÅ Promo code applied! Wallet ‡¶è ‚Çπ${bonus} ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
});

// =========================
// Leaderboard System
// =========================
bot.onText(/\/leaderboard/, async (msg) => {
  const users = await User.find();
  const top = users.sort((a,b)=>b.totalReferrals - a.totalReferrals).slice(0,10);
  let text = "üèÜ Top Referrers:\n";
  top.forEach((u,i)=>text+=`${i+1}. ${u.username} ‚Üí ${u.totalReferrals}\n`);
  bot.sendMessage(msg.chat.id, text);
});

// =========================
// Reseller System
// =========================
bot.onText(/\/reseller_stats/, async (msg) => {
  const chatId = msg.chat.id;
  if (!["reseller", "admin"].includes(user.role)) return bot.sendMessage(chatId, "‚ùå Access denied.");

  // Count total keys sold (simulate)
  const soldKeys = 10; // Example
  const cashback = soldKeys * 15; // 15 per key
  bot.sendMessage(chatId, `üìä Reseller Stats:\nTotal Keys Sold: ${soldKeys}\nCashback Earned: ‚Çπ${cashback}`);
});



// =========================
// Bot.js (Part 3/3) - Admin Panel
// =========================

bot.onText(/\/admin/, async (msg) => {
  const chatId = msg.chat.id;
  if (chatId.toString() !== process.env.ADMIN_ID) return bot.sendMessage(chatId, "‚ùå Only Admin can use this.");

  bot.sendMessage(chatId, "üõ† Admin Panel", {
    reply_markup: {
      inline_keyboard: [
        [{ text: "üí∞ Total Users", callback_data: "admin_total_users" }],
        [{ text: "üì• Pending Deposits", callback_data: "admin_pending_deposits" }],
        [{ text: "üéÅ Set Referral Bot Username", callback_data: "admin_set_ref_bot" }],
        [{ text: "üìä Analytics", callback_data: "admin_analytics" }]
      ]
    }
  });
});

// =========================
// Admin Inline Handlers
// =========================
bot.on("callback_query", async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;

  if (chatId.toString() !== process.env.ADMIN_ID) return bot.answerCallbackQuery(query.id, { text: "‚ùå Only Admin" });

  // Total Users
  if (data === "admin_total_users") {
    const total = await User.countDocuments();
    bot.sendMessage(chatId, `üë• Total Users: ${total}`);
  }

  // Pending Deposits
  if (data === "admin_pending_deposits") {
    if (!global.deposits || !global.deposits.length) return bot.sendMessage(chatId, "‚ùå No pending deposits.");
    let txt = "üì• Pending Deposits:\n";
    global.deposits.forEach((d, i) => {
      if (d.status === "pending") txt += `${i+1}. User: ${d.userId} | ‚Çπ${d.amount} | UTR: ${d.utr}\n`;
    });
    bot.sendMessage(chatId, txt);
  }

  // Set Referral Bot Username
  if (data === "admin_set_ref_bot") {
    bot.sendMessage(chatId, "‚úèÔ∏è Send the new Bot username for referral link:");
    bot.once("message", async (msg) => {
      const newUsername = msg.text.trim();
      await setReferralBotUsername(newUsername);
      bot.sendMessage(chatId, `‚úÖ Referral Bot Username updated: ${newUsername}`);
    });
  }

  // Analytics
  if (data === "admin_analytics") {
    const users = await User.find();
    let totalReferrals = users.reduce((acc,u)=>acc+u.totalReferrals,0);
    let walletTotal = users.reduce((acc,u)=>acc+u.wallet,0);
    bot.sendMessage(chatId,
`üìä Analytics:
Total Users: ${users.length}
Total Wallet Balance: ‚Çπ${walletTotal}
Total Referrals: ${totalReferrals}`);
  }

  bot.answerCallbackQuery(query.id, { text: "‚úÖ Done" });
});
